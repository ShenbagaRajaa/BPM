name: Build iOS IPA

on:
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Capacitor sync
        run: |
          npm run build
          npx cap sync ios

      # ---------------------------
      # Update Podfile
      # ---------------------------
      - name: Update Podfile to disable Pod code signing
        run: |
          cat > ios/App/Podfile << 'EOF'
          require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'
          
          platform :ios, '14.0'
          use_frameworks!
          
          install! 'cocoapods', :disable_input_output_paths => true
          
          def capacitor_pods
            pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
            pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
            pod 'CapacitorApp', :path => '../../node_modules/@capacitor/app'
            pod 'CapacitorBrowser', :path => '../../node_modules/@capacitor/browser'
          end
          
          target 'App' do
            capacitor_pods
          end
          
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                # Disable code signing for all Pod targets
                config.build_settings['CODE_SIGN_IDENTITY'] = ''
                config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
                config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
                config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
                
                # Clear provisioning profiles
                config.build_settings.delete('PROVISIONING_PROFILE_SPECIFIER')
                config.build_settings.delete('PROVISIONING_PROFILE')
                config.build_settings.delete('PRODUCT_BUNDLE_IDENTIFIER')
                
                # Optional: Disable previews
                config.build_settings['ENABLE_PREVIEWS'] = 'NO'
                config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-O'
              end
            end
          end
          EOF

      - name: Install Pods
        run: |
          cd ios/App/
          pod install --repo-update

      # ---------------------------
      # Certificates & Provisioning
      # ---------------------------
      - name: Setup Keychain and Import Certificate
        run: |
          # Decode certificate
          echo "${{ secrets.CERT_P12 }}" | base64 --decode > ios_distribution.p12
          
          # Create keychain
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security default-keychain -s build.keychain
          
          # Import certificate
          security import ios_distribution.p12 \
            -k build.keychain \
            -f pkcs12 \
            -P "${{ secrets.CERT_P12_PASSWORD }}" \
            -A
          
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain

      - name: Install Provisioning Profile
        env:
          PROFILE_BASE64: ${{ secrets.PROFILE_BASE64 }}
        run: |
          # Create provisioning profiles directory
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # Decode to temporary location
          echo "$PROFILE_BASE64" | base64 --decode > /tmp/profile.mobileprovision
          
          # Extract UUID
          PROFILE_UUID=$(security cms -D -i /tmp/profile.mobileprovision | grep -A 1 "<key>UUID</key>" | grep "<string>" | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          
          echo "Profile UUID: $PROFILE_UUID"
          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
          
          # Move profile with UUID as filename
          mv /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/${PROFILE_UUID}.mobileprovision
          
          echo "‚úÖ Provisioning profile installed"

      - name: Verify Code Signing Setup
        run: |
          echo "üìã Code Signing Identities:"
          security find-identity -p codesigning -v
          
          echo ""
          echo "üìã Provisioning Profiles:"
          ls -lh ~/Library/MobileDevice/Provisioning\ Profiles/
          
          echo ""
          echo "üìã Profile UUID: ${PROFILE_UUID}"
     # ---------------------------
      # Set Manual Signing and Build Settings (Using Workspace)
      # ---------------------------
      - name: Set Manual Signing and Build Settings
        run: |
          echo "Setting Code Signing Style to Manual for App target..."
          # NOTE: We must use the WORKSPACE and SCHEME so the build can see Pods dependencies
          /usr/bin/xcrun xcodebuild \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Release \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            DEVELOPMENT_TEAM=J6MWBCBLW7 \
            PROVISIONING_PROFILE_SPECIFIER="${PROFILE_UUID}" \
            CODE_SIGN_ENTITLEMENTS=App/app.entitlements
          
          echo "‚úÖ Xcode project signing style set to Manual"
      # ---------------------------
      # Build & Archive
      # ---------------------------
      - name: Build and Archive IPA
        run: |
          xcodebuild clean \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Release
          
          xcodebuild archive \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath output/App.xcarchive \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            DEVELOPMENT_TEAM=J6MWBCBLW7 \
            PROVISIONING_PROFILE_SPECIFIER="${PROFILE_UUID}" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_ENTITLEMENTS=App/app.entitlements \
            CODE_SIGN_IDENTITY="Apple Distribution"

      - name: Create exportOptions.plist
        run: |
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>J6MWBCBLW7</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.bpmgr.app</key>
                  <string>${PROFILE_UUID}</string>
              </dict>
          </dict>
          </plist>
          EOF

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath output/App.xcarchive \
            -exportOptionsPlist exportOptions.plist \
            -exportPath output \
            -allowProvisioningUpdates

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: output/*.ipa

      - name: Extract and Verify IPA Entitlements
        if: always()
        run: |
          echo "üì¶ Extracting IPA..."
          cd output
          IPA_FILE=$(ls *.ipa | head -n 1)
          echo "Found IPA: $IPA_FILE"

          unzip -q "$IPA_FILE"
    
          echo ""
          echo "üìÇ Contents after extraction:"
          ls -la
    
          echo ""
          echo "üìÇ Payload contents:"
          ls -la Payload/
    
          echo ""
          echo "üîç Checking entitlements embedded in app..."
          APP_PATH=$(find Payload -name "*.app" -type d | head -n 1)
          echo "App path: $APP_PATH"
    
          if [ -n "$APP_PATH" ]; then
            echo ""
            echo "üìã Entitlements in signed app:"
            codesign -d --entitlements :- "$APP_PATH"
      
            echo ""
            echo "üìã Bundle ID:"
            /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$APP_PATH/Info.plist"
      
            echo ""
            echo "üîç Checking for Associated Domains in entitlements:"
            codesign -d --entitlements :- "$APP_PATH" | grep -A 10 "associated-domains" || echo "‚ùå No Associated Domains found"
          else
            echo "‚ùå Could not find .app in Payload"
          fi
