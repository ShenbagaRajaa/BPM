name: Build iOS IPA

on:
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Capacitor sync
        run: |
          npm run build
          npx cap sync ios

      # ---------------------------
      # Certificates & provisioning
      # ---------------------------
          
      - name: Decode certificate
        run: |
          echo "${{ secrets.CERT_P12 }}" | base64 --decode > ios_distribution.p12
      - name: Validate p12
        run: |
          openssl pkcs12 -info -in ios_distribution.p12 -nokeys -passin pass:"${{ secrets.CERT_P12_PASSWORD }}" || true

      - name: Setup keychain
        run: |
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security default-keychain -s build.keychain

      - name: Import certificate
        run: |
          security import ios_distribution.p12 \
          -k build.keychain \
          -f pkcs12 \
          -P "${{ secrets.CERT_P12_PASSWORD }}" \
          -A
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain

      - name: Debug secret
        run: |
          if [ -z "$PROFILE_BASE64" ]; then
            echo "ERROR: PROFILE_BASE64 is empty!"
          else
            echo "PROFILE_BASE64 length: ${#PROFILE_BASE64}"
            echo "First 100 chars: ${PROFILE_BASE64:0:100}"
          fi
        env:
          PROFILE_BASE64: ${{ secrets.PROFILE_BASE64 }}

      - name: Install provisioning profile
        env:
          PROFILE_BASE64: ${{ secrets.PROFILE_BASE64 }}
        run: |
          if [ -z "$PROFILE_BASE64" ]; then
            echo "ERROR: PROFILE_BASE64 secret is not set or is empty"
            exit 1
          fi
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/iOS_Test.mobileprovision
          if [ ! -f ~/Library/MobileDevice/Provisioning\ Profiles/iOS_Test.mobileprovision ]; then
            echo "ERROR: Profile file was not created"
            exit 1
          fi
          FILE_SIZE=$(wc -c < ~/Library/MobileDevice/Provisioning\ Profiles/iOS_Test.mobileprovision)
          echo "Profile file size: $FILE_SIZE bytes"
    
          if [ "$FILE_SIZE" -lt 100 ]; then
            echo "ERROR: Profile file is too small, likely corrupted"
            cat ~/Library/MobileDevice/Provisioning\ Profiles/iOS_Test.mobileprovision
            exit 1
          fi
      # - name: Install provisioning profile
      #   env:
      #     PROFILE_BASE64: ${{ secrets.PROFILE_BASE64 }}
      #     run: |
      #       mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
      #       echo "$PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/iOS_Test.mobileprovision
      
      - name: Debug provisioning profile
        run: |
          ls -lh ~/Library/MobileDevice/Provisioning\ Profiles/
          file ~/Library/MobileDevice/Provisioning\ Profiles/iOS_Test.mobileprovision
          head -c 100 ~/Library/MobileDevice/Provisioning\ Profiles/iOS_Test.mobileprovision | xxd

      - name: Verify provisioning profile
        run: |
          security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/iOS_Test.mobileprovision | grep -A 2 UUID

      - name: Show installed code signing identities
        run: security find-identity -p codesigning -v

      # ---------------------------
      # Build IPA
      # ---------------------------
      # - name: Build IPA with Xcode
      #   run: |
      #     xcodebuild archive \
      #     -workspace ios/App/App.xcworkspace \
      #     -scheme App \
      #     -configuration Release \
      #     -archivePath output/App.xcarchive \
      #     -destination generic/platform=iOS \
      #     DEVELOPMENT_TEAM=J6MWBCBLW7 \
      #     CODE_SIGN_STYLE=Manual \
      #     PRODUCT_BUNDLE_IDENTIFIER=com.bpmgr.app
      #     CODE_SIGN_IDENTITY="Apple Distribution" \
      #     PROVISIONING_PROFILE_SPECIFIER="iOS_Test"
      - name: List provisioning profiles
        run: |
          ls -lh ~/Library/MobileDevice/Provisioning\ Profiles/
          file ~/Library/MobileDevice/Provisioning\ Profiles/iOS_Test.mobileprovision
          security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/iOS_Test.mobileprovision | grep -A 2 UUID

      - name: Build IPA with Xcode
        run: |
          xcodebuild archive \
          -workspace ios/App/App.xcworkspace \
          -scheme App \
          -configuration Release \
          -archivePath output/App.xcarchive \
          -destination generic/platform=iOS \
          -xcconfig ios/App/App.xcconfig
          # -allowProvisioningUpdates



      # - name: Export IPA
      #   run: |
      #     xcodebuild -exportArchive \
      #       -archivePath output/App.xcarchive \
      #       -exportOptionsPlist ios/App/exportOptions.plist \
      #       -exportPath output
      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath output/App.xcarchive \
            -exportOptionsPlist ios/App/exportOptions.plist \
            -exportPath output


      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: output/*.ipa
