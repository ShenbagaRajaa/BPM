name: Build iOS IPA

on:
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Capacitor sync
        run: |
          npm run build
          npx cap sync ios
          
      - name: Install Pods
        run: |
          cd ios/App/
          pod install --repo-update

      # ---------------------------
      # Certificates & provisioning
      # ---------------------------
          
      - name: Decode and import certificate
        run: |
          echo "${{ secrets.CERT_P12 }}" | base64 --decode > ios_distribution.p12
          
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security default-keychain -s build.keychain
          
          security import ios_distribution.p12 \
            -k build.keychain \
            -f pkcs12 \
            -P "${{ secrets.CERT_P12_PASSWORD }}" \
            -A
          
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain

      - name: Install provisioning profile
        env:
          PROFILE_BASE64: ${{ secrets.PROFILE_BASE64 }}
        run: |
          if [ -z "$PROFILE_BASE64" ]; then
            echo "ERROR: PROFILE_BASE64 secret is not set"
            exit 1
          fi
          
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # Decode to temporary location
          echo "$PROFILE_BASE64" | base64 --decode > /tmp/profile.mobileprovision
          
          # Extract UUID from profile
          PROFILE_UUID=$(security cms -D -i /tmp/profile.mobileprovision | grep -A 1 "<key>UUID</key>" | grep "<string>" | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          
          echo "Profile UUID: $PROFILE_UUID"
          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
          
          # Move profile with UUID as filename
          mv /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/${PROFILE_UUID}.mobileprovision
          
          echo "‚úÖ Provisioning profile installed"

      - name: Verify setup
        run: |
          echo "üîç Checking code signing identity..."
          security find-identity -p codesigning -v
          
          echo ""
          echo "üîç Checking provisioning profile..."
          ls -lh ~/Library/MobileDevice/Provisioning\ Profiles/
          
          echo ""
          echo "üìã Profile details:"
          security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/${PROFILE_UUID}.mobileprovision | grep -E "(Name|UUID|ApplicationIdentifierPrefix|application-identifier)" | head -10

      # ---------------------------
      # Build IPA
      # ---------------------------
      - name: Build and Archive
        run: |
          xcodebuild clean \
          -workspace ios/App/App.xcworkspace \
          -scheme App \
          -configuration Release
  
          cd ios/App && pod install && cd ../..
    
          xcodebuild archive \
          -workspace ios/App/App.xcworkspace \
          -scheme App \
          -configuration Release \
          -archivePath output/App.xcarchive \
          -destination 'generic/platform=iOS'
          
      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath output/App.xcarchive \
            -exportOptionsPlist ios/App/exportOptions.plist \
            -exportPath output

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: output/*.ipa
