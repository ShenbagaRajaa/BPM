<div class="toolbar-container">
  <div
    class="md:flex tablet:z-50 md:z-1000 hidden md:flex-row tablet:flex tablet:bg-toolbarEx tablet:flex-row tablet:pt-10 md:pt-4 md:bg-toolbarEx md:shadow-md"
  >
    <mat-toolbar
      class="hidden md:flex w-full items-center px-5 py-2 shadow-md tablet:bg-toolbarBg bg-toolbarBg"
    >
      <div class="flex items-center flex-1">
        <img
          src="assets/logo.png"
          alt="Logo"
          class="w-[200px] tablet:hidden md:block"
        />
        <img
          src="assets/Sample 1.png"
          alt="Logo"
          class="w-[50px] tablet:block md:hidden"
        />
        <div class="border-l-2 border-gray-300 h-10 mx-5"></div>
        <button mat-icon-button (click)="toggleDrawer()">
          <mat-icon>menu</mat-icon>
        </button>
      </div>

      <div class="flex items-center space-x-4">
        <div class="relative">
          <button mat-icon-button (click)="toggleNotifications()">
            <mat-icon
              aria-hidden="false"
              aria-label="notification"
              [matBadge]="unreadCount"
              [matBadgeHidden]="unreadCount === 0"
              matBadgeColor="warn"
              matBadgeSize="small"
            >
              notifications
            </mat-icon>
          </button>
        </div>

        <div
          mat-button
          [matMenuTriggerFor]="menu"
          class="flex items-center cursor-pointer gap-4"
        >
          <div
            class="w-8 h-8 rounded-full flex items-center justify-center bg-[#3a3a81] text-white"
          >
            <img
              *ngIf="profilePhotoUrl"
              [src]="profilePhotoUrl"
              alt="Profile"
              class="w-full h-full object-cover rounded-full"
            />
            <span *ngIf="!profilePhotoUrl">{{ userInitials$ | async }}</span>
          </div>
          <span class="hidden tablet:inline md:inline">{{
            name$ | async
          }}</span>
          <mat-icon>keyboard_arrow_down</mat-icon>
        </div>
      </div>
    </mat-toolbar>
  </div>

  <div
    class="flex pt-12 md:hidden w-full items-center justify-between px-5 tablet:hidden bg-mBg overflow-hidden"
    style="box-shadow: 3px 5px 0 rgba(0, 0, 0, 0.1)"
  >
    <img src="assets/Sample 1.png" alt="Logo" />

    <div class="flex items-center space-x-4">
      <button
        mat-icon-button
        [matMenuTriggerFor]="notification"
        #menuTrigger="matMenuTrigger"
      >
        <mat-icon
          aria-hidden="false"
          aria-label="notification"
          [matBadge]="unreadCount"
          [matBadgeHidden]="unreadCount === 0"
          matBadgeColor="warn"
          matBadgeSize="small"
        >
          notifications
        </mat-icon>
      </button>
      <div
        mat-button
        [matMenuTriggerFor]="menu"
        class="flex items-center cursor-pointer gap-4"
      >
        <div
          class="w-8 h-8 rounded-full flex items-center justify-center bg-[#3a3a81] text-white"
        >
          <img
            *ngIf="profilePhotoUrl"
            [src]="profilePhotoUrl"
            alt="Profile"
            class="w-full h-full object-cover rounded-full"
          />
          <span *ngIf="!profilePhotoUrl">{{ userInitials$ | async }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<mat-menu #menu="matMenu" class="min-w-[200px]">
  <div class="px-4 py-2 border-b">
    <div class="font-medium">{{ currentUser.role }}</div>
    <div class="text-sm text-gray-500">{{ currentUser.email }}</div>
  </div>

  <button mat-menu-item [routerLink]="['/home/viewUser', currentUser.email]">
    <div class="flex items-center gap-4">
      <div
        class="w-8 h-8 rounded-full flex items-center justify-center bg-[#3a3a81] text-white"
      >
        <img
          *ngIf="profilePhotoUrl"
          [src]="profilePhotoUrl"
          alt="Profile"
          class="w-full h-full object-cover rounded-full"
        />
        <span *ngIf="!profilePhotoUrl">{{ userInitials$ | async }}</span>
      </div>
      <span>Profile</span>
    </div>
  </button>

  <div class="border-t">
    <button mat-menu-item (click)="logout()">
      <mat-icon>exit_to_app</mat-icon>
      <span>Logout</span>
    </button>
  </div>
  <!-- <div class="border-t">
    <button mat-menu-item (click)="deleteUser()">
      <mat-icon class="!text-red-500">delete</mat-icon>
      <span class="text-red-500">Delete User</span>
    </button>
  </div> -->
</mat-menu>

<ng-container *ngIf="(notifications$ | async)?.length"> </ng-container>

<div
  *ngIf="notificationsOpen"
  class="absolute top-24 md:top-20 tablet:top-28 right-0 w-96 bg-white shadow-lg rounded-lg overflow-hidden z-50"
>
  <div class="flex justify-between items-center px-4 py-2 border-b bg-gray-100">
    <span class="font-medium text-lg">Notifications</span>

    <button
      *ngIf="unreadCount > 0"
      (click)="markAllAsRead()"
      class="text-text font-bold bg-toolbarBg shadow-sm hover:bg-lblue border-2 p-2"
    >
      Mark all as read
    </button>
  </div>

  <div
    class="notification-categories flex justify-evenly items-center bg-gray-50 px-4 py-2 border-b"
  >
    <button
      (click)="showAll()"
      class="font-semibold hover:bg-lblue p-2"
      [ngClass]="{
        'text-text font-bold bg-lblue': selectedCategory === 'All',
        'text-gray-500 font-semibold': selectedCategory !== 'All'
      }"
    >
      Show All ({{ (notifications$ | async)?.length }})
    </button>
    <button
      (click)="setCategory(false)"
      class="font-semibold hover:bg-lblue p-2"
      [ngClass]="{
        'text-text font-bold bg-lblue': selectedCategory === 'Unread',
        'text-gray-500 font-semibold': selectedCategory !== 'Unread'
      }"
    >
      Unread ({{ unreadCount }})
    </button>
    <button
      (click)="setCategory(true)"
      class="hover:bg-lblue p-2"
      [ngClass]="{
        'text-text font-bold bg-lblue': selectedCategory === 'Read',
        'text-gray-500 font-semibold': selectedCategory !== 'Read'
      }"
    >
      Read ({{ readCount }})
    </button>
  </div>

  <div class="notification-scroll overflow-y-auto">
    <ng-template #noNotifications>
      <div class="p-4 text-center text-gray-500">
        No notifications available
      </div>
    </ng-template>
    <ng-container
      *ngIf="(notificationsDisplay$ | async)?.length; else noNotifications"
    >
      <div
        *ngFor="let notification of notificationsDisplay$ | async"
        class="p-4 border-b hover:bg-lblue transition-colors"
      >
        <div class="flex items-start gap-3">
          <mat-icon
            [class.text-blue-500]="notification.priority === 'Medium'"
            [class.text-red-500]="notification.priority === 'High'"
            [class.text-gray-500]="notification.eventType === 'Low'"
          >
            {{
              notification.eventType === "task"
                ? "assignment"
                : notification.eventType === "approval"
                ? "gavel"
                : "info"
            }}
          </mat-icon>

          <div class="flex-1">
            <p class="text-sm font-medium">
              {{ notification.eventType }}
            </p>
            <p class="text-sm font-small">
              {{ notification.description }}
            </p>
            <div class="mt-2 flex justify-between items-center">
              <small class="text-gray-500">
                {{ notification.createdDate | date : "short" }}
              </small>
              <button
                mat-stroked-button
                class="notificationButton text-text shadow-sm bg-lblue px-4 mobile:py-2 rounded-md cursor-pointer"
                (click)="markAsRead(notification)"
                *ngIf="!notification.isRead"
              >
                {{
                  notification.linkURL === "" || notification.linkURL === null
                    ? "Mark as Read"
                    : "Take Action"
                }}
              </button>
            </div>
          </div>

          <button mat-icon-button class="text-gray-400 hover:text-gray-600">
            <mat-icon
              [class.text-text]="notification.isRead === false"
              [class.text-gray-300]="notification.isRead === true"
              >adjust</mat-icon
            >
          </button>
        </div>
      </div>
    </ng-container>
  </div>
</div>

<mat-menu #notification="matMenu" class="notification-menu">
  <div class="notification-container" (click)="$event.stopPropagation()">
    <div
      class="flex justify-between items-center px-4 py-2 border-b bg-gray-100"
    >
      <span class="font-medium text-lg">Notifications</span>
      <button
        *ngIf="unreadCount > 0"
        (click)="markAllAsRead(); $event.stopPropagation()"
        class="text-text font-bold bg-toolbarBg shadow-sm hover:bg-lblue border-2 p-2"
      >
        Mark all as read
      </button>
    </div>

    <div
      class="notification-categories flex justify-evenly items-center bg-gray-50 px-4 py-2 border-b"
    >
      <button
        (click)="showAll(); $event.stopPropagation()"
        class="font-semibold hover:bg-lblue p-2"
        [ngClass]="{
          'text-text font-bold bg-lblue': selectedCategory === 'All',
          'text-gray-500 font-semibold': selectedCategory !== 'All'
        }"
      >
        Show All ({{ (notifications$ | async)?.length }})
      </button>
      <button
        (click)="setCategory(false); $event.stopPropagation()"
        class="font-semibold hover:bg-lblue p-2"
        [ngClass]="{
          'text-text font-bold bg-lblue': selectedCategory === 'Unread',
          'text-gray-500 font-semibold': selectedCategory !== 'Unread'
        }"
      >
        Unread ({{ unreadCount }})
      </button>
      <button
        (click)="setCategory(true); $event.stopPropagation()"
        class="hover:bg-lblue p-2"
        [ngClass]="{
          'text-text font-bold bg-lblue': selectedCategory === 'Read',
          'text-gray-500 font-semibold': selectedCategory !== 'Read'
        }"
      >
        Read ({{ readCount }})
      </button>
    </div>

    <div class="notification-scroll overflow-y-auto">
      <ng-template #noNotifications>
        <div class="p-4 text-center text-gray-500">
          No notifications available
        </div>
      </ng-template>

      <ng-container
        *ngIf="(notificationsDisplay$ | async)?.length; else noNotifications"
      >
        <div
          *ngFor="let notification of notificationsDisplay$ | async"
          class="p-4 border-b hover:bg-lblue transition-colors"
        >
          <div class="flex items-start gap-3">
            <mat-icon
              [class.text-blue-500]="notification.priority === 'Medium'"
              [class.text-red-500]="notification.priority === 'High'"
              [class.text-gray-500]="notification.eventType === 'Low'"
            >
              {{
                notification.eventType === "task"
                  ? "assignment"
                  : notification.eventType === "approval"
                  ? "gavel"
                  : "info"
              }}
            </mat-icon>

            <div class="flex-1">
              <p class="text-sm font-medium">
                {{ notification.eventType }}
              </p>
              <p class="text-sm font-small">
                {{ notification.description }}
              </p>
              <div class="mt-2 flex justify-between items-center">
                <small class="text-gray-500">
                  {{ notification.createdDate | date : "short" }}
                </small>
                <button
                  mat-stroked-button
                  *ngIf="!notification.isRead"
                  class="notificationButton text-text shadow-sm bg-lblue px-4 rounded-md cursor-pointer"
                  style="
                    white-space: nowrap;
                    min-width: fit-content;
                    padding: 8px 16px !important;
                  "
                  (click)="markAsRead(notification, menuTrigger)"
                >
                  {{
                    notification.linkURL === "" || notification.linkURL === null
                      ? "Mark as Read"
                      : "Take Action"
                  }}
                </button>
              </div>
            </div>

            <button mat-icon-button class="text-gray-400 hover:text-gray-600">
              <mat-icon
                [class.text-text]="notification.isRead === false"
                [class.text-gray-300]="notification.isRead === true"
              >
                adjust
              </mat-icon>
            </button>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</mat-menu>
